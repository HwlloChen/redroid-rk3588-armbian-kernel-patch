# Redroid-rk3588 å†…æ ¸è¡¥ä¸ç”Ÿæˆè„šæœ¬

## ğŸ“‹ ç®€ä»‹

è¿™ä¸ªè„šæœ¬ç”¨äºè‡ªåŠ¨ç”Ÿæˆ Armbian RK3588 å†…æ ¸æ‰€éœ€çš„ Redroid è¡¥ä¸ã€‚å®ƒé€šè¿‡å¯¹æ¯” Armbian å®˜æ–¹å†…æ ¸å’Œ CNflysky ä¿®æ”¹è¿‡çš„å†…æ ¸ï¼Œæå–å‡ºæ”¯æŒ `system-uncached-dma32` DMA heap è®¾å¤‡çš„å…³é”®å·®å¼‚ï¼Œå¹¶ç”Ÿæˆå¯ç›´æ¥åº”ç”¨äº Armbian ç¼–è¯‘æµç¨‹çš„è¡¥ä¸æ–‡ä»¶ã€‚

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªè„šæœ¬ï¼Ÿ

### é—®é¢˜èƒŒæ™¯

- **Redroid-rk3588** éœ€è¦å†…æ ¸æä¾› `system-uncached-dma32` DMA heap è®¾å¤‡æ‰èƒ½æ­£å¸¸ä½¿ç”¨ GPU ç¡¬ä»¶åŠ é€Ÿ
- è¯¥è®¾å¤‡åœ¨ Linux 6.1 ä¸»çº¿å†…æ ¸ä¸­å·²è¢«ç§»é™¤
- Armbian é»˜è®¤å†…æ ¸ï¼ˆrk-6.1-rkr5.1 åˆ†æ”¯ï¼‰ä¸åŒ…å«æ­¤è®¾å¤‡
- CNflysky åœ¨å…¶ fork çš„å†…æ ¸ï¼ˆrk-6.1-rkr4.1 åˆ†æ”¯ï¼‰ä¸­æ·»åŠ äº†å¿…è¦çš„ä»£ç 

### è§£å†³æ–¹æ¡ˆ

æ‰‹åŠ¨å¯¹æ¯”ä¸¤ä¸ªå†…æ ¸åˆ†æ”¯å¹¶æå–å·®å¼‚å·¥ä½œé‡å·¨å¤§ä¸”å®¹æ˜“å‡ºé”™ã€‚è¿™ä¸ªè„šæœ¬è‡ªåŠ¨åŒ–äº†æ•´ä¸ªè¿‡ç¨‹ï¼Œç¡®ä¿ï¼š

âœ… åªæå–å¿…è¦çš„å·®å¼‚ï¼ˆDMA-BUF ç›¸å…³ä»£ç ï¼‰
âœ… ç”Ÿæˆç¬¦åˆ Armbian è¡¥ä¸æ ¼å¼çš„æ ‡å‡† patch æ–‡ä»¶
âœ… å¯é‡å¤æ‰§è¡Œï¼Œä¾¿äºæ›´æ–°å’Œç»´æŠ¤

## ğŸ“¦ å‰ç½®è¦æ±‚

### ç³»ç»Ÿç¯å¢ƒ
- **æ“ä½œç³»ç»Ÿï¼š** Ubuntu 22.04 LTS æˆ–ç±»ä¼¼ Debian ç³»å‘è¡Œç‰ˆ
- **å†…å­˜ï¼š** è‡³å°‘ 8GB RAM
- **å­˜å‚¨ç©ºé—´ï¼š** è‡³å°‘ 15GB å¯ç”¨ç©ºé—´
- **æƒé™ï¼š** å»ºè®®ä»¥ root ç”¨æˆ·è¿è¡Œï¼ˆé¿å…æƒé™é—®é¢˜ï¼‰

### å¿…éœ€å·¥å…·
```bash
sudo apt update
sudo apt install -y git diffutils coreutils
```

### Armbian æ„å»ºç¯å¢ƒ
è„šæœ¬éœ€è¦åœ¨å·²å…‹éš†çš„ Armbian build ç›®å½•ç¯å¢ƒä¸­ä½¿ç”¨ï¼š
```bash
cd ~
git clone --depth=1 https://github.com/armbian/build
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åˆ›å»ºè„šæœ¬æ–‡ä»¶

```bash
cd ~
touch generate_redroid_patch.sh
chmod +x generate_redroid_patch.sh
```

### 2. ç¼–è¾‘è„šæœ¬å†…å®¹

å°†è„šæœ¬ä»£ç å¤åˆ¶åˆ°æ–‡ä»¶ä¸­ï¼ˆä½¿ç”¨ vimã€nano æˆ–å…¶ä»–ç¼–è¾‘å™¨ï¼‰ï¼š

```bash
vim generate_redroid_patch.sh
```

### 3. é…ç½®å‚æ•°ï¼ˆå¯é€‰ï¼‰

è„šæœ¬é¡¶éƒ¨çš„é…ç½®å‚æ•°å¯æ ¹æ®éœ€è¦ä¿®æ”¹ï¼š

```bash
# Armbian build ç›®å½•è·¯å¾„
ARMBIAN_BUILD_DIR="$HOME/build"

# Armbian ç›®æ ‡å†…æ ¸åˆ†æ”¯ï¼ˆæ ¹æ®ä½ çš„ç¼–è¯‘é…ç½®è°ƒæ•´ï¼‰
TARGET_KERNEL_BRANCH="rk35xx-vendor-6.1"

# åŸºå‡†å†…æ ¸åˆ†æ”¯ï¼ˆArmbian å®˜æ–¹ï¼‰
ARMBIAN_KERNEL_BRANCH="rk-6.1-rkr5.1"

# ç›®æ ‡å†…æ ¸åˆ†æ”¯ï¼ˆCNflysky ä¿®æ”¹ç‰ˆï¼‰
CNFLYSKY_KERNEL_BRANCH="rk-6.1-rkr4.1"
```

**å…³é”®å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | ä½•æ—¶ä¿®æ”¹ |
|------|------|--------|----------|
| `ARMBIAN_BUILD_DIR` | Armbian build ç›®å½•è·¯å¾„ | `$HOME/build` | å¦‚æœ build ç›®å½•åœ¨å…¶ä»–ä½ç½® |
| `TARGET_KERNEL_BRANCH` | ä½ çš„ç›®æ ‡å†…æ ¸åˆ†æ”¯ | `rk35xx-vendor-6.1` | æ ¹æ® `./compile.sh` æ˜¾ç¤ºçš„å®é™…åˆ†æ”¯å |
| `ARMBIAN_KERNEL_BRANCH` | Armbian åŸºå‡†åˆ†æ”¯ | `rk-6.1-rkr5.1` | é€šå¸¸æ— éœ€ä¿®æ”¹ |
| `CNFLYSKY_KERNEL_BRANCH` | CNflysky å†…æ ¸åˆ†æ”¯ | `rk-6.1-rkr4.1` | é€šå¸¸æ— éœ€ä¿®æ”¹ |

### 4. è¿è¡Œè„šæœ¬

```bash
./generate_redroid_patch.sh
```

### 5. éªŒè¯è¾“å‡º

è„šæœ¬æˆåŠŸæ‰§è¡Œåï¼Œè¡¥ä¸æ–‡ä»¶å°†ç”Ÿæˆåœ¨ï¼š
```
~/build/userpatches/kernel/rk35xx-vendor-6.1/0002-dma-uncached-dma32.patch
```

éªŒè¯è¡¥ä¸å†…å®¹ï¼š
```bash
cat ~/build/userpatches/kernel/rk35xx-vendor-6.1/0002-dma-uncached-dma32.patch
```

## ğŸ”§ å·¥ä½œåŸç†

### æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å…‹éš† Armbian å®˜æ–¹å†…æ ¸ (Base)    â”‚
â”‚    rk-6.1-rkr5.1                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å…‹éš† CNflysky å†…æ ¸ (Target)     â”‚
â”‚    rk-6.1-rkr4.1                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å¯¹æ¯”æŒ‡å®šè·¯å¾„å·®å¼‚                 â”‚
â”‚    - drivers/dma-buf/               â”‚
â”‚    - include/linux/dma-buf.h        â”‚
â”‚    - include/linux/dma-heap.h       â”‚
â”‚    - include/linux/android_kabi.h   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ä½¿ç”¨ diff -Nurb ç”Ÿæˆç»Ÿä¸€æ ¼å¼è¡¥ä¸â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. è¾“å‡ºåˆ° Armbian userpatches ç›®å½• â”‚
â”‚    è‡ªåŠ¨åº”ç”¨äºåç»­å†…æ ¸ç¼–è¯‘           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æŠ€æœ¯ç‚¹

1. **ç²¾ç¡®å·®å¼‚æå–ï¼š** åªå¯¹æ¯” DMA-BUF ç›¸å…³æ–‡ä»¶ï¼Œé¿å…å¼•å…¥ä¸å¿…è¦çš„å˜æ›´
2. **ç»Ÿä¸€è¡¥ä¸æ ¼å¼ï¼š** ä½¿ç”¨ `diff -Nurb` ç”Ÿæˆç¬¦åˆ GNU æ ‡å‡†çš„è¡¥ä¸
3. **è‡ªåŠ¨é›†æˆï¼š** è¾“å‡ºåˆ° `userpatches/kernel/` ç›®å½•ï¼ŒArmbian ç¼–è¯‘æ—¶è‡ªåŠ¨åº”ç”¨

## â“ å¸¸è§é—®é¢˜

### Q1: è„šæœ¬è¿è¡Œå¤±è´¥ï¼Œæç¤º "å…‹éš†å¤±è´¥"

**åŸå› ï¼š** ç½‘ç»œé—®é¢˜æˆ– GitHub è®¿é—®å—é™

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# é…ç½® Git ä»£ç†ï¼ˆå¦‚æœä½¿ç”¨ä»£ç†ï¼‰
git config --global http.proxy http://127.0.0.1:7890

# æˆ–ä½¿ç”¨ GitHub é•œåƒç«™
# ä¿®æ”¹è„šæœ¬ä¸­çš„ä»“åº“ URLï¼š
# https://github.com/armbian/linux-rockchip.git
# æ”¹ä¸º
# https://mirror.ghproxy.com/https://github.com/armbian/linux-rockchip.git
```

### Q2: ç”Ÿæˆçš„è¡¥ä¸æ–‡ä»¶ä¸ºç©ºæˆ–å¾ˆå°

**åŸå› ï¼š** å†…æ ¸åˆ†æ”¯ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œæˆ–æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ‰‹åŠ¨éªŒè¯ä¸¤ä¸ªä»“åº“çš„åˆ†æ”¯æ˜¯å¦å­˜åœ¨
git ls-remote https://github.com/armbian/linux-rockchip.git | grep rk-6.1-rkr5.1
git ls-remote https://github.com/CNflysky/linux-rockchip.git | grep rk-6.1-rkr4.1
```

### Q3: Armbian ç¼–è¯‘æ—¶è¡¥ä¸åº”ç”¨å¤±è´¥

**åŸå› ï¼š** ç›®æ ‡å†…æ ¸åˆ†æ”¯åç§°é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
1. å…ˆè¿è¡Œä¸€æ¬¡ `./compile.sh`ï¼Œè§‚å¯Ÿå®é™…ä½¿ç”¨çš„å†…æ ¸åˆ†æ”¯å
2. ä¿®æ”¹è„šæœ¬ä¸­çš„ `TARGET_KERNEL_BRANCH` å‚æ•°
3. é‡æ–°ç”Ÿæˆè¡¥ä¸

### Q4: è¡¥ä¸åº”ç”¨åç¼–è¯‘å†…æ ¸ä»ç„¶å¤±è´¥

**åŸå› ï¼š** å¯èƒ½è¿˜éœ€è¦é¢å¤–çš„å†…æ ¸é…ç½®é€‰é¡¹

**è§£å†³æ–¹æ¡ˆï¼š**
ç¡®ä¿å†…æ ¸é…ç½®ä¸­å¯ç”¨äº†ï¼š
- `CONFIG_ARM64_VA_BITS=39`
- `CONFIG_ANDROID_BINDERFS=y`
- `CONFIG_PSI=y`
- `CONFIG_DMABUF_HEAPS=y`

## ğŸ“ è¡¥ä¸æ–‡ä»¶è¯´æ˜

ç”Ÿæˆçš„è¡¥ä¸æ–‡ä»¶æ ¼å¼ç¤ºä¾‹ï¼š

```diff
From: Redroid Contributor <cnflysky@users.noreply.github.com>
Subject: [PATCH 0002] dma-heap: Add system-uncached-dma32 and necessary files for Redroid GPU

---
diff -Nurb armbian-rkr5.1-base/drivers/dma-buf/dma-heap.c cnflysky-rkr4.1-target/drivers/dma-buf/dma-heap.c
--- armbian-rkr5.1-base/drivers/dma-buf/dma-heap.c	2024-01-01 00:00:00.000000000 +0000
+++ cnflysky-rkr4.1-target/drivers/dma-buf/dma-heap.c	2024-01-01 00:00:00.000000000 +0000
@@ -123,6 +123,9 @@
 	// ... è¡¥ä¸å†…å®¹ ...
```

## ğŸ”— ç›¸å…³èµ„æº

- **Armbian æ„å»ºæ–‡æ¡£ï¼š** https://docs.armbian.com/Developer-Guide_Build-Preparation/
- **Redroid-rk3588 é¡¹ç›®ï¼š** https://github.com/CNflysky/redroid-rk3588
- **CNflysky å†…æ ¸ä»“åº“ï¼š** https://github.com/CNflysky/linux-rockchip
- **Armbian å†…æ ¸ä»“åº“ï¼š** https://github.com/armbian/linux-rockchip

## ğŸ“„ è®¸å¯è¯

æœ¬è„šæœ¬éµå¾ª [MIT è®¸å¯è¯](LICENSE)ã€‚

---

**æç¤ºï¼š** å¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå»ºè®®æŸ¥çœ‹å®Œæ•´çš„ [RK3588 äº‘æ‰‹æœºæ­å»ºæŒ‡å—](https://blog.etaris.moe/posts/%E7%94%A8RK3588%E8%AE%BE%E5%A4%87%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E4%BA%91%E6%89%8B%E6%9C%BA/)ã€‚
